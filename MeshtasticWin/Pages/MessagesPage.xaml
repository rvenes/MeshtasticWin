<Page
    x:Class="MeshtasticWin.Pages.MessagesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MeshtasticWin.Pages">

	    <Grid Padding="12">
	        <Grid.ColumnDefinitions>
	            <ColumnDefinition Width="360"/>
	            <ColumnDefinition Width="12"/>
	            <ColumnDefinition Width="*"/>
	        </Grid.ColumnDefinitions>

	        <!-- LEFT: chat/node list -->
	        <Grid Grid.Column="0" RowDefinitions="Auto,6,Auto,6,Auto,6,*">
	            <TextBlock Text="Chats" FontSize="22" FontWeight="SemiBold" />

	            <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="12" Opacity="0.85" VerticalAlignment="Center">
                <ToggleButton x:Name="HideInactiveToggle" Content="Hide inactive" Click="HideInactiveToggle_Click"/>
                <ComboBox x:Name="SortCombo" Width="200" SelectionChanged="SortCombo_SelectionChanged"/>
	            </StackPanel>

	            <TextBox Grid.Row="4"
	                     x:Name="ChatSearchBox"
	                     PlaceholderText="Search (name / id)"
	                     TextChanged="ChatSearchBox_TextChanged"/>

            <ListView Grid.Row="6"
                      x:Name="ChatList"
                      ItemsSource="{x:Bind ChatsView, Mode=OneWay}"
                      SelectionMode="Single"
                      SelectionChanged="ChatList_SelectionChanged">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="local:ChatListItemVm">
                        <Grid Padding="6" RowDefinitions="Auto,Auto" ColumnDefinitions="Auto,*,Auto">
	                            <Ellipse Width="8" Height="8" Margin="0,0,8,0"
                                     Fill="LimeGreen"
                                     VerticalAlignment="Center"
                                     Visibility="{x:Bind UnreadVisible}"/>

	                            <TextBlock Grid.Column="1" Text="{x:Bind Title}" FontWeight="SemiBold" VerticalAlignment="Center" />
	                            <TextBlock Grid.Column="2" Text="{x:Bind ShortId}" Opacity="0.7" VerticalAlignment="Center"/>

	                            <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="8" Opacity="0.8" Margin="0,2,0,0">
	                                <TextBlock Text="{x:Bind LastHeard}" />
	                                <TextBlock Text="SNR:"/>
	                                <TextBlock Text="{x:Bind SNR}" />
	                                <TextBlock Text="RSSI:"/>
	                                <TextBlock Text="{x:Bind RSSI}" />
	                            </StackPanel>
	                        </Grid>
	                    </DataTemplate>
	                </ListView.ItemTemplate>
	            </ListView>
	        </Grid>

	        <!-- RIGHT: messages -->
	        <Grid Grid.Column="2" RowDefinitions="Auto,12,*,12,Auto">
	            <!-- Header -->
	            <TextBlock Text="{x:Bind ActiveChatTitle, Mode=OneWay}" FontSize="30" FontWeight="SemiBold" />

            <!-- Messages -->
            <ListView Grid.Row="2"
                      x:Name="MessagesList"
                      ItemsSource="{x:Bind SelectedChatMessages, Mode=OneWay}">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="local:MessageVm">
                        <StackPanel Spacing="4" Padding="10"
                                    Visibility="{x:Bind RowVisibility}">
	                            <StackPanel Orientation="Horizontal" Spacing="12">
	                                <TextBlock Text="{x:Bind Header}" FontWeight="SemiBold"/>
	                                <TextBlock Text="{x:Bind When}" Opacity="0.7"/>
	                            </StackPanel>

	                            <Grid ColumnDefinitions="Auto,Auto,*" ColumnSpacing="6">
	                                <!-- ✓ (heard) -->
	                                <FontIcon Glyph="&#xE73E;"
	                                          Foreground="Green"
	                                          FontFamily="Segoe MDL2 Assets"
	                                          Visibility="{x:Bind HeardVisible}" />

	                                <!-- ✓✓ (delivered) -->
	                                <FontIcon Glyph="&#xE73E;"
                                              Grid.Column="1"
	                                          Foreground="Green"
	                                          FontFamily="Segoe MDL2 Assets"
	                                          Visibility="{x:Bind DeliveredVisible}" />

                                <RichTextBlock IsTextSelectionEnabled="True"
                                               Grid.Column="2"
                                               TextWrapping="Wrap"
                                               Loaded="MessageText_Loaded"
                                               DataContextChanged="MessageText_DataContextChanged"
                                               Tag="{x:Bind Text, Mode=OneWay}">
                                    <RichTextBlock.ContextFlyout>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="Copy" Click="CopyMessageText_Click"/>
                                        </MenuFlyout>
                                    </RichTextBlock.ContextFlyout>
                                </RichTextBlock>
                            </Grid>
                        </StackPanel>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

	            <!-- Composer -->
	            <Grid Grid.Row="4">
	                <Grid.ColumnDefinitions>
	                    <ColumnDefinition Width="*"/>
	                    <ColumnDefinition Width="12"/>
	                    <ColumnDefinition Width="46"/>
	                    <ColumnDefinition Width="8"/>
	                    <ColumnDefinition Width="Auto"/>
	                    <ColumnDefinition Width="8"/>
	                    <ColumnDefinition Width="96"/>
	                </Grid.ColumnDefinitions>

	                <TextBox x:Name="InputBox"
	                         PlaceholderText="Type a message..."
	                         AcceptsReturn="False"
	                         TextChanged="InputBox_TextChanged"
	                         KeyDown="InputBox_KeyDown"/>

                    <Button Grid.Column="2"
                            Content="😊"
                            ToolTipService.ToolTip="Insert emoji">
                        <Button.Flyout>
                            <MenuFlyout>
                                <MenuFlyoutItem Text="😀" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="😂" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="🙂" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="😍" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="👍" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="🙏" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="❤️" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="🔥" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="🎉" Click="InsertEmojiMenuItem_Click"/>
                                <MenuFlyoutItem Text="🇳🇴" Click="InsertEmojiMenuItem_Click"/>
                            </MenuFlyout>
                        </Button.Flyout>
                    </Button>

                    <TextBlock Grid.Column="4"
                               x:Name="MessageLengthText"
                               Text="0/200 bytes"
                               Opacity="0.75"
                               VerticalAlignment="Center"/>

	                <Button Grid.Column="6"
	                        Content="Send"
	                        Click="Send_Click"/>
	            </Grid>
	        </Grid>
	    </Grid>
</Page>
