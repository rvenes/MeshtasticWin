<Page
    x:Class="MeshtasticWin.Pages.NodesPage"
    x:Name="Root"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:MeshtasticWin.Models"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:localcontrols="using:MeshtasticWin.Controls">

    <Grid Padding="12">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="360"/>
            <ColumnDefinition Width="12"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- LEFT -->
        <Grid Grid.Column="0" RowDefinitions="Auto,6,Auto,6,Auto,6,*">
            <TextBlock Text="Nodes" FontSize="22" FontWeight="SemiBold" />

            <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="12" Opacity="0.85" VerticalAlignment="Center">
                <TextBlock Text="{x:Bind NodeCountsText, Mode=OneWay}"/>
                <ToggleButton x:Name="HideInactiveToggle" Content="Hide inactive" Click="HideInactiveToggle_Click"/>
                <ComboBox x:Name="AgeFilterCombo" Width="170" SelectionChanged="AgeFilterCombo_SelectionChanged"/>
            </StackPanel>

            <TextBox Grid.Row="4"
                     x:Name="SearchBox"
                     PlaceholderText="Search (name / id)"
                     TextChanged="SearchBox_TextChanged"/>

            <ListView Grid.Row="6"
                      x:Name="NodesList"
                      ItemsSource="{x:Bind FilteredNodesView, Mode=OneWay}"
                      SelectionMode="Single"
                      SelectionChanged="NodesList_SelectionChanged"
                      DoubleTapped="NodesList_DoubleTapped">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:NodeLive">
                        <Grid Padding="6" RowDefinitions="Auto,Auto" ColumnDefinitions="Auto,*,Auto">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="4" Margin="0,0,8,0">
                                <Ellipse Width="8" Height="8"
                                         Fill="LimeGreen"
                                         VerticalAlignment="Center"
                                         Visibility="{x:Bind LogIndicatorVisible}"/>
                                <Ellipse Width="8" Height="8"
                                         Fill="LimeGreen"
                                         VerticalAlignment="Center"
                                         Visibility="{x:Bind UnreadVisible}"/>
                            </StackPanel>

                            <TextBlock Grid.Column="1" Text="{x:Bind Name}" FontWeight="SemiBold" VerticalAlignment="Center" />
                            <TextBlock Grid.Column="2" Text="{x:Bind ShortId}" Opacity="0.7" VerticalAlignment="Center"/>

                            <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="8" Opacity="0.8" Margin="0,2,0,0">
                                <TextBlock Text="{x:Bind LastHeard}" />
                                <TextBlock Text="SNR:"/>
                                <TextBlock Text="{x:Bind SNR}" />
                                <TextBlock Text="RSSI:"/>
                                <TextBlock Text="{x:Bind RSSI}" />
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <!-- RIGHT -->
        <Grid Grid.Column="2" RowDefinitions="Auto,8,Auto,8,*,Auto">
            <!-- More height here: info + buttons fit without covering the position text. -->
            <Border CornerRadius="10" Padding="12" Background="{ThemeResource CardBackgroundFillColorDefault}">
                <Grid RowDefinitions="Auto,6,Auto" ColumnDefinitions="*,Auto">
                    <Grid RowDefinitions="Auto,8,Auto,Auto,Auto,Auto" ColumnDefinitions="Auto,*" ColumnSpacing="12">
                        <StackPanel Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <TextBlock Text="{x:Bind SelectedTitle, Mode=OneWay}" FontSize="20" FontWeight="SemiBold"/>
                            <Button Content="Open current position"
                                    Click="OpenCurrentPosition_Click"
                                    IsEnabled="{x:Bind HasSelectedPosition, Mode=OneWay}"/>
                        </StackPanel>

                        <TextBlock Grid.Row="2" Text="Node number:" Opacity="0.75"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{x:Bind SelectedNodeNumText, Mode=OneWay}"/>

                        <TextBlock Grid.Row="3" Text="Last heard:" Opacity="0.75"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{x:Bind SelectedLastHeardText, Mode=OneWay}"/>

                        <TextBlock Grid.Row="4" Text="GPS position:" Opacity="0.75"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" Text="{x:Bind SelectedPosText, Mode=OneWay}"/>

                        <TextBlock Grid.Row="5" Text="Short name:" Opacity="0.75"/>
                        <TextBlock Grid.Row="5" Grid.Column="1" Text="{x:Bind SelectedShortNameText, Mode=OneWay}"/>
                    </Grid>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" VerticalAlignment="Top">
                        <Button Content="Send DM" Click="SendDm_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                    </StackPanel>
                </Grid>
            </Border>

            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                <Button Content="Exchange User Info" Click="ExchangeUserInfo_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                <Button Content="Exchange Positions" Click="ExchangePositions_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                <Button Content="{x:Bind TraceRouteButtonText, Mode=OneWay}" Click="TraceRoute_Click" IsEnabled="{x:Bind IsTraceRouteEnabled, Mode=OneWay}"/>
                <Button Content="{x:Bind GpsTrackButtonText, Mode=OneWay}" Click="ToggleGpsTrack_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                <Button Content="Zoom" Click="ZoomToNode_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                <Button Content="Fit" Click="FitAll_Click"/>
                <Button Content="Reset map" Click="ResetMap_Click"/>
            </StackPanel>

            <Border Grid.Row="4"
                    CornerRadius="10"
                    Background="{ThemeResource CardBackgroundFillColorDefault}"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch">
                <controls:TabView x:Name="DetailsTabs"
                                  IsAddTabButtonVisible="False"
                                  SelectionChanged="DetailsTabs_SelectionChanged"
                                  HorizontalContentAlignment="Stretch"
                                  VerticalContentAlignment="Stretch"
                                  HorizontalAlignment="Stretch"
                                  VerticalAlignment="Stretch">
                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Map"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <Border CornerRadius="10"
                                Background="{ThemeResource CardBackgroundFillColorDefault}"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch">
                            <Grid RowDefinitions="*"
                                  HorizontalAlignment="Stretch"
                                  VerticalAlignment="Stretch">
                                <controls:WebView2 x:Name="MapView"
                                                   HorizontalAlignment="Stretch"
                                                   VerticalAlignment="Stretch"
                                                   MinHeight="300"/>
                            </Grid>
                        </Border>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Device Metrics"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind DeviceMetricsTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <Grid RowDefinitions="Auto,Auto,*" Padding="12">
                            <Grid ColumnDefinitions="*,Auto" VerticalAlignment="Center">
                                <TextBlock Text="{x:Bind DeviceMetricsCountText, Mode=OneWay}" FontWeight="SemiBold"/>
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                    <Button Content="Show folder"
                                            Tag="DeviceMetrics"
                                            Click="ShowLogFolder_Click"
                                            IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                    <TextBlock Text="Delete older than (days):" VerticalAlignment="Center"/>
                                    <controls:NumberBox Width="96"
                                                        Value="{x:Bind PositionLogRetentionDaysValue, Mode=TwoWay}"
                                                        Minimum="1"
                                                        SpinButtonPlacementMode="Inline"/>
                                    <Button Content="Delete"
                                            Tag="DeviceMetrics"
                                            Click="DeleteLogOlder_Click"
                                            IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                    <Button Content="Delete all"
                                            Tag="DeviceMetrics"
                                            Click="DeleteLogAll_Click"
                                            IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                    <Button Content="Export..."
                                            Click="SaveDeviceMetrics_Click"
                                            IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                </StackPanel>
                            </Grid>
                            <Grid Grid.Row="1" RowDefinitions="Auto,*" Margin="0,8,0,8">
                                <StackPanel Orientation="Horizontal" Spacing="16">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <Ellipse Width="8" Height="8" Fill="#FF4CAF50"/>
                                        <TextBlock Text="Battery"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <Ellipse Width="8" Height="8" Fill="#FF2196F3"/>
                                        <TextBlock Text="Channel Utilization"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <Ellipse Width="8" Height="8" Fill="#FFFF9800"/>
                                        <TextBlock Text="Airtime"/>
                                    </StackPanel>
                                </StackPanel>
                                <localcontrols:DeviceMetricsGraph Grid.Row="1"
                                                                  x:Name="DeviceMetricsGraph"
                                                                  Height="220"/>
                            </Grid>
                            <ListView Grid.Row="2"
                                      x:Name="DeviceMetricsLogList"
                                      ItemsSource="{Binding DeviceMetricSamples, ElementName=Root}"
                                      SelectionMode="None">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="MinHeight" Value="22"/>
                                        <Setter Property="Padding" Value="2"/>
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="Auto,*,Auto" Padding="2">
                                            <TextBlock Text="{Binding TimestampText}" FontFamily="Consolas" FontSize="12"/>
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12">
                                                <TextBlock Text="{Binding BatteryDisplay}" FontFamily="Consolas" FontSize="12"/>
                                                <TextBlock Text="{Binding ChannelUtilizationDisplay}" FontFamily="Consolas" FontSize="12"/>
                                                <TextBlock Text="{Binding AirtimeDisplay}" FontFamily="Consolas" FontSize="12"/>
                                            </StackPanel>
                                            <TextBlock Grid.Column="2"
                                                       Text="{Binding PoweredDisplay}"
                                                       FontFamily="Consolas"
                                                       FontSize="12"
                                                       Foreground="OrangeRed"
                                                       FontWeight="SemiBold"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </Grid>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Position Log"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind PositionTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <Grid RowDefinitions="Auto,*" Padding="12">
                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <Button Content="Show folder"
                                        Tag="Position"
                                        Click="ShowLogFolder_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <TextBlock Text="Delete older than (days):" VerticalAlignment="Center"/>
                                <controls:NumberBox Width="96"
                                                    Value="{x:Bind PositionLogRetentionDaysValue, Mode=TwoWay}"
                                                    Minimum="1"
                                                    SpinButtonPlacementMode="Inline"/>
                                <Button Content="Delete"
                                        Tag="Position"
                                        Click="DeleteLogOlder_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <Button Content="Delete all"
                                        Tag="Position"
                                        Click="DeleteLogAll_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <Button Content="Export..."
                                        Click="ExportPositionLog_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                            </StackPanel>
                            <ListView Grid.Row="1"
                                      x:Name="PositionLogList"
                                      ItemsSource="{x:Bind PositionLogEntries, Mode=OneWay}"
                                      SelectionMode="Single"
                                      SelectionChanged="PositionLogList_SelectionChanged"
                                      IsItemClickEnabled="True"
                                      ItemClick="PositionLogList_ItemClick">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding DisplayText}"
                                                   TextWrapping="NoWrap"
                                                   FontFamily="Consolas"
                                                   IsRightTapEnabled="True"
                                                   RightTapped="PositionLogEntry_RightTapped">
                                            <TextBlock.ContextFlyout>
                                                <MenuFlyout>
                                                    <MenuFlyoutItem Text="Open position in Google Maps"
                                                                    Click="PositionLogOpenMaps_Click"
                                                                    CommandParameter="{Binding}"
                                                                    IsEnabled="{Binding HasValidPosition}"/>
                                                </MenuFlyout>
                                            </TextBlock.ContextFlyout>
                                        </TextBlock>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </Grid>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Trace Route Log"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind TraceRouteTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <Grid RowDefinitions="Auto,*" Padding="12">
                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <Button Content="Show folder"
                                        Tag="TraceRoute"
                                        Click="ShowLogFolder_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <TextBlock Text="Delete older than (days):" VerticalAlignment="Center"/>
                                <controls:NumberBox Width="96"
                                                    Value="{x:Bind PositionLogRetentionDaysValue, Mode=TwoWay}"
                                                    Minimum="1"
                                                    SpinButtonPlacementMode="Inline"/>
                                <Button Content="Delete"
                                        Tag="TraceRoute"
                                        Click="DeleteLogOlder_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <Button Content="Delete all"
                                        Tag="TraceRoute"
                                        Click="DeleteLogAll_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <Button Content="Export..." IsEnabled="False"/>
                            </StackPanel>
                            <TextBox Grid.Row="1"
                                     Text="{x:Bind TraceRouteLogText, Mode=OneWay}"
                                     IsReadOnly="True"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="True"
                                     FontFamily="Consolas"
                                     Padding="8"
                                     Margin="0,8,0,0"/>
                        </Grid>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Power Metrics"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind PowerMetricsTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <Grid RowDefinitions="Auto,*" Padding="12">
                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <Button Content="Show folder"
                                        Tag="PowerMetrics"
                                        Click="ShowLogFolder_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <TextBlock Text="Delete older than (days):" VerticalAlignment="Center"/>
                                <controls:NumberBox Width="96"
                                                    Value="{x:Bind PositionLogRetentionDaysValue, Mode=TwoWay}"
                                                    Minimum="1"
                                                    SpinButtonPlacementMode="Inline"/>
                                <Button Content="Delete"
                                        Tag="PowerMetrics"
                                        Click="DeleteLogOlder_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <Button Content="Delete all"
                                        Tag="PowerMetrics"
                                        Click="DeleteLogAll_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <Button Content="Export..." IsEnabled="False"/>
                            </StackPanel>
                            <TextBox Grid.Row="1"
                                     Text="{x:Bind PowerMetricsLogText, Mode=OneWay}"
                                     IsReadOnly="True"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="True"
                                     FontFamily="Consolas"
                                     Padding="8"
                                     Margin="0,8,0,0"/>
                        </Grid>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Detection Sensor Log"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind DetectionSensorTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <Grid RowDefinitions="Auto,*" Padding="12">
                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <Button Content="Show folder"
                                        Tag="DetectionSensor"
                                        Click="ShowLogFolder_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <TextBlock Text="Delete older than (days):" VerticalAlignment="Center"/>
                                <controls:NumberBox Width="96"
                                                    Value="{x:Bind PositionLogRetentionDaysValue, Mode=TwoWay}"
                                                    Minimum="1"
                                                    SpinButtonPlacementMode="Inline"/>
                                <Button Content="Delete"
                                        Tag="DetectionSensor"
                                        Click="DeleteLogOlder_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <Button Content="Delete all"
                                        Tag="DetectionSensor"
                                        Click="DeleteLogAll_Click"
                                        IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                                <Button Content="Export..." IsEnabled="False"/>
                            </StackPanel>
                            <TextBox Grid.Row="1"
                                     Text="{x:Bind DetectionSensorLogText, Mode=OneWay}"
                                     IsReadOnly="True"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="True"
                                     FontFamily="Consolas"
                                     Padding="8"
                                     Margin="0,8,0,0"/>
                        </Grid>
                    </controls:TabViewItem>
                </controls:TabView>
            </Border>

            <TextBlock Grid.Row="5"
                       x:Name="MapFallbackText"
                       Text="Map assets missing"
                       Visibility="Collapsed"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       TextWrapping="Wrap"
                       FontSize="16"
                       Opacity="0.8"
                       Margin="0,8,0,0"/>
        </Grid>
    </Grid>
</Page>
