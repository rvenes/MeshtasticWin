<Page
    x:Class="MeshtasticWin.Pages.NodesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:MeshtasticWin.Models"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls">

    <Grid Padding="12">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="360"/>
            <ColumnDefinition Width="12"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- LEFT -->
        <Grid Grid.Column="0" RowDefinitions="Auto,6,Auto,6,Auto,6,*">
            <TextBlock Text="Nodes" FontSize="22" FontWeight="SemiBold" />

            <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="12" Opacity="0.85" VerticalAlignment="Center">
                <TextBlock Text="{x:Bind NodeCountsText, Mode=OneWay}"/>
                <ToggleButton x:Name="HideInactiveToggle" Content="Hide inactive" Click="HideInactiveToggle_Click"/>
                <ComboBox x:Name="AgeFilterCombo" Width="170" SelectionChanged="AgeFilterCombo_SelectionChanged"/>
            </StackPanel>

            <TextBox Grid.Row="4"
                     x:Name="SearchBox"
                     PlaceholderText="Search (name / id)"
                     TextChanged="SearchBox_TextChanged"/>

            <ListView Grid.Row="6"
                      x:Name="NodesList"
                      ItemsSource="{x:Bind FilteredNodesView, Mode=OneWay}"
                      SelectionMode="Single"
                      SelectionChanged="NodesList_SelectionChanged"
                      DoubleTapped="NodesList_DoubleTapped">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:NodeLive">
                        <Grid Padding="6" RowDefinitions="Auto,Auto" ColumnDefinitions="Auto,*,Auto">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="4" Margin="0,0,8,0">
                                <Ellipse Width="8" Height="8"
                                         Fill="LimeGreen"
                                         VerticalAlignment="Center"
                                         Visibility="{x:Bind LogIndicatorVisible}"/>
                                <Ellipse Width="8" Height="8"
                                         Fill="LimeGreen"
                                         VerticalAlignment="Center"
                                         Visibility="{x:Bind UnreadVisible}"/>
                            </StackPanel>

                            <TextBlock Grid.Column="1" Text="{x:Bind Name}" FontWeight="SemiBold" VerticalAlignment="Center" />
                            <TextBlock Grid.Column="2" Text="{x:Bind ShortId}" Opacity="0.7" VerticalAlignment="Center"/>

                            <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="8" Opacity="0.8" Margin="0,2,0,0">
                                <TextBlock Text="{x:Bind LastHeard}" />
                                <TextBlock Text="SNR:"/>
                                <TextBlock Text="{x:Bind SNR}" />
                                <TextBlock Text="RSSI:"/>
                                <TextBlock Text="{x:Bind RSSI}" />
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <!-- RIGHT -->
        <Grid Grid.Column="2" RowDefinitions="Auto,8,Auto,8,*,Auto">
            <!-- More height here: info + buttons fit without covering the position text. -->
            <Border CornerRadius="10" Padding="12" Background="{ThemeResource CardBackgroundFillColorDefault}">
                <Grid RowDefinitions="Auto,6,Auto,6,Auto" ColumnDefinitions="Auto,*,Auto">
                    <StackPanel Spacing="2">
                        <TextBlock Text="{x:Bind SelectedTitle, Mode=OneWay}" FontSize="20" FontWeight="SemiBold"/>
                        <TextBlock Text="{x:Bind SelectedIdHex, Mode=OneWay}" Opacity="0.85"/>
                        <TextBlock Text="{x:Bind SelectedNodeNumText, Mode=OneWay}" Opacity="0.85"/>
                        <TextBlock Text="{x:Bind SelectedLastHeardText, Mode=OneWay}" Opacity="0.85"/>
                        <TextBlock Text="{x:Bind SelectedPosText, Mode=OneWay}" Opacity="0.85"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" VerticalAlignment="Top">
                        <Button Content="Send DM" Click="SendDm_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                        <Button Content="Load GPS track" Click="ReadGpsLog_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                        <Button Content="Zoom" Click="ZoomToNode_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                        <Button Content="Fit" Click="FitAll_Click"/>
                    </StackPanel>

                    <TextBlock Grid.Row="4" Text="{x:Bind SelectedExtraText, Mode=OneWay}" Opacity="0.75" TextWrapping="Wrap"/>
                </Grid>
            </Border>

            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                <Button Content="Exchange User Info" Click="ExchangeUserInfo_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                <Button Content="Exchange Positions" Click="ExchangePositions_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                <Button Content="{x:Bind TraceRouteButtonText, Mode=OneWay}" Click="TraceRoute_Click" IsEnabled="{x:Bind IsTraceRouteEnabled, Mode=OneWay}"/>
            </StackPanel>

            <Border Grid.Row="4"
                    CornerRadius="10"
                    Background="{ThemeResource CardBackgroundFillColorDefault}"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    MinHeight="200">
                <controls:TabView x:Name="DetailsTabs"
                                  SelectionChanged="DetailsTabs_SelectionChanged"
                                  HorizontalContentAlignment="Stretch"
                                  VerticalContentAlignment="Stretch">
                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Map"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <Border CornerRadius="10"
                                Background="{ThemeResource CardBackgroundFillColorDefault}"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                MinHeight="200">
                            <Grid RowDefinitions="*"
                                  HorizontalAlignment="Stretch"
                                  VerticalAlignment="Stretch">
                                <controls:WebView2 x:Name="MapView"
                                                   HorizontalAlignment="Stretch"
                                                   VerticalAlignment="Stretch"
                                                   MinHeight="200"/>
                            </Grid>
                        </Border>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Device Metrics"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind DeviceMetricsTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <TextBox Text="{x:Bind DeviceMetricsLogText, Mode=OneWay}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 FontFamily="Consolas"
                                 Padding="12"/>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Position Log"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind PositionTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <Grid RowDefinitions="*,Auto" Padding="12">
                            <ListView x:Name="PositionLogList"
                                      ItemsSource="{x:Bind PositionLogEntries, Mode=OneWay}"
                                      SelectionMode="Single"
                                      SelectionChanged="PositionLogList_SelectionChanged">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding DisplayText}" TextWrapping="NoWrap" FontFamily="Consolas"/>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8" Margin="0,8,0,0">
                                <Button Content="Open in Google Maps" Click="OpenMaps_Click" IsEnabled="{x:Bind HasPositionSelection, Mode=OneWay}"/>
                            </StackPanel>
                        </Grid>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Trace Route Log"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind TraceRouteTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <TextBox Text="{x:Bind TraceRouteLogText, Mode=OneWay}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 FontFamily="Consolas"
                                 Padding="12"/>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Power Metrics"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind PowerMetricsTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <TextBox Text="{x:Bind PowerMetricsLogText, Mode=OneWay}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 FontFamily="Consolas"
                                 Padding="12"/>
                    </controls:TabViewItem>

                    <controls:TabViewItem IsClosable="False">
                        <controls:TabViewItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Detection Sensor Log"/>
                                <Ellipse Width="8" Height="8" Fill="LimeGreen" VerticalAlignment="Center"
                                         Visibility="{x:Bind DetectionSensorTabIndicatorVisibility, Mode=OneWay}"/>
                            </StackPanel>
                        </controls:TabViewItem.Header>
                        <TextBox Text="{x:Bind DetectionSensorLogText, Mode=OneWay}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 FontFamily="Consolas"
                                 Padding="12"/>
                    </controls:TabViewItem>
                </controls:TabView>
            </Border>

            <TextBlock Grid.Row="5"
                       x:Name="MapFallbackText"
                       Text="Map assets missing"
                       Visibility="Collapsed"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       TextWrapping="Wrap"
                       FontSize="16"
                       Opacity="0.8"
                       Margin="0,8,0,0"/>
        </Grid>
    </Grid>
</Page>
