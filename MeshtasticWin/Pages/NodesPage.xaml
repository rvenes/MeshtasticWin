<Page
    x:Class="MeshtasticWin.Pages.NodesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:MeshtasticWin.Models"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls">

    <Grid Padding="12">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="360"/>
            <ColumnDefinition Width="12"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- LEFT -->
        <Grid Grid.Column="0" RowDefinitions="Auto,6,Auto,6,Auto,6,*">
            <TextBlock Text="Nodes" FontSize="22" FontWeight="SemiBold" />

            <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="12" Opacity="0.85" VerticalAlignment="Center">
                <TextBlock Text="{x:Bind NodeCountsText, Mode=OneWay}"/>
                <ToggleButton x:Name="HideInactiveToggle" Content="Hide inactive" Click="HideInactiveToggle_Click"/>
                <ComboBox x:Name="AgeFilterCombo" Width="170" SelectionChanged="AgeFilterCombo_SelectionChanged"/>
            </StackPanel>

            <TextBox Grid.Row="4"
                     x:Name="SearchBox"
                     PlaceholderText="Search (name / id)"
                     TextChanged="SearchBox_TextChanged"/>

            <ListView Grid.Row="6"
                      x:Name="NodesList"
                      ItemsSource="{x:Bind FilteredNodesView, Mode=OneWay}"
                      SelectionMode="Single"
                      SelectionChanged="NodesList_SelectionChanged"
                      DoubleTapped="NodesList_DoubleTapped">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:NodeLive">
                        <Grid Padding="6" RowDefinitions="Auto,Auto" ColumnDefinitions="Auto,*,Auto">
                            <Ellipse Width="8" Height="8" Margin="0,0,8,0"
                                     Fill="LimeGreen"
                                     VerticalAlignment="Center"
                                     Visibility="{x:Bind UnreadVisible}"/>

                            <TextBlock Grid.Column="1" Text="{x:Bind Name}" FontWeight="SemiBold" VerticalAlignment="Center" />
                            <TextBlock Grid.Column="2" Text="{x:Bind ShortId}" Opacity="0.7" VerticalAlignment="Center"/>

                            <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="8" Opacity="0.8" Margin="0,2,0,0">
                                <TextBlock Text="{x:Bind LastHeard}" />
                                <TextBlock Text="SNR:"/>
                                <TextBlock Text="{x:Bind SNR}" />
                                <TextBlock Text="RSSI:"/>
                                <TextBlock Text="{x:Bind RSSI}" />
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <!-- RIGHT -->
        <Grid Grid.Column="2" RowDefinitions="Auto,8,Auto,8,Auto,8,*">
            <!-- More height here: info + buttons fit without covering the position text. -->
            <Border CornerRadius="10" Padding="12" Background="{ThemeResource CardBackgroundFillColorDefault}">
                <Grid RowDefinitions="Auto,6,Auto,6,Auto" ColumnDefinitions="Auto,*,Auto">
                    <StackPanel Spacing="2">
                        <TextBlock Text="{x:Bind SelectedTitle, Mode=OneWay}" FontSize="20" FontWeight="SemiBold"/>
                        <TextBlock Text="{x:Bind SelectedIdHex, Mode=OneWay}" Opacity="0.85"/>
                        <TextBlock Text="{x:Bind SelectedNodeNumText, Mode=OneWay}" Opacity="0.85"/>
                        <TextBlock Text="{x:Bind SelectedLastHeardText, Mode=OneWay}" Opacity="0.85"/>
                        <TextBlock Text="{x:Bind SelectedPosText, Mode=OneWay}" Opacity="0.85"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" VerticalAlignment="Top">
                        <Button Content="Send DM" Click="SendDm_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                        <Button Content="Load GPS track" Click="ReadGpsLog_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                        <Button Content="Zoom" Click="ZoomToNode_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}"/>
                        <Button Content="Fit" Click="FitAll_Click"/>
                    </StackPanel>

                    <TextBlock Grid.Row="4" Text="{x:Bind SelectedExtraText, Mode=OneWay}" Opacity="0.75" TextWrapping="Wrap"/>
                </Grid>
            </Border>

            <Border Grid.Row="2" CornerRadius="10" Padding="12" Background="{ThemeResource CardBackgroundFillColorDefault}">
                <StackPanel Spacing="8">
                    <TextBlock Text="Logs" FontSize="16" FontWeight="SemiBold"/>
                    <ItemsControl HorizontalAlignment="Left">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsWrapGrid Orientation="Horizontal" ItemWidth="220" ItemHeight="44"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <Button Click="DeviceMetricsLog_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="Device Metrics Log" TextWrapping="Wrap"/>
                        </Button>
                        <Button Click="PositionLog_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="Position Log" TextWrapping="Wrap"/>
                        </Button>
                        <Button Click="EnvironmentMetricsLog_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="Environment Metrics Log" TextWrapping="Wrap"/>
                        </Button>
                        <Button Click="TraceRouteLog_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="Trace Route Log" TextWrapping="Wrap"/>
                        </Button>
                        <Button Click="PowerMetricsLog_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="Power Metrics Log" TextWrapping="Wrap"/>
                        </Button>
                        <Button Click="DetectionSensorLog_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="Detection Sensor Log" TextWrapping="Wrap"/>
                        </Button>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <Border Grid.Row="4" CornerRadius="10" Padding="12" Background="{ThemeResource CardBackgroundFillColorDefault}">
                <StackPanel Spacing="8">
                    <TextBlock Text="Actions" FontSize="16" FontWeight="SemiBold"/>
                    <ItemsControl HorizontalAlignment="Left">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsWrapGrid Orientation="Horizontal" ItemWidth="220" ItemHeight="44"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <Button Click="ExchangeUserInfo_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="Exchange User Info" TextWrapping="Wrap"/>
                        </Button>
                        <Button Click="ExchangePositions_Click" IsEnabled="{x:Bind HasSelection, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="Exchange Positions" TextWrapping="Wrap"/>
                        </Button>
                        <Button Click="TraceRoute_Click" IsEnabled="{x:Bind IsTraceRouteEnabled, Mode=OneWay}" Margin="0,0,8,8" HorizontalContentAlignment="Center">
                            <TextBlock Text="{x:Bind TraceRouteButtonText, Mode=OneWay}" TextWrapping="Wrap"/>
                        </Button>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <Border Grid.Row="6" CornerRadius="10" Background="{ThemeResource CardBackgroundFillColorDefault}">
                <controls:WebView2 x:Name="MapView"/>
            </Border>
        </Grid>
    </Grid>
</Page>
